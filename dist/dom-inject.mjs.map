{"version":3,"file":"dom-inject.mjs","sources":["../src/index.js"],"sourcesContent":["/**\n * Written by Elliott Mangham at Code Resolution. Maintained by Code Resolution.\n * made@coderesolution.com\n */\nimport DOMPurify from 'dompurify'\n\nexport default class ContentFetch {\n\tconstructor(options = {}) {\n\t\tthis.options = {\n\t\t\tloadingClass: options.loadingClass || 'is-loading',\n\t\t\tloadedClass: options.loadedClass || 'has-loaded',\n\t\t\terrorClass: options.errorClass || 'has-error',\n\t\t\tdebugMode: options.debugMode || false,\n\t\t\t...options,\n\t\t}\n\t\tthis.cache = new Map()\n\t\tthis.controller = new AbortController()\n\t}\n\n\tlog(message) {\n\t\tif (this.options.debugMode) {\n\t\t\tconsole.log(message)\n\t\t}\n\t}\n\n\tfetchContent(url, sourceScope = null, includeParent = false) {\n\t\treturn fetch(url, { signal: this.controller.signal })\n\t\t\t.then((response) => {\n\t\t\t\tif (!response.ok) {\n\t\t\t\t\tthrow new Error('Network response was not ok.')\n\t\t\t\t}\n\t\t\t\tthis.log('Fetch response received')\n\t\t\t\treturn response.text()\n\t\t\t})\n\t\t\t.then((data) => {\n\t\t\t\tconst parser = new DOMParser()\n\t\t\t\tconst doc = parser.parseFromString(data, 'text/html')\n\t\t\t\tlet element = sourceScope ? doc.querySelector(sourceScope) : doc.body\n\t\t\t\tif (!element) {\n\t\t\t\t\tthrow new Error(`Element not found for selector: ${sourceScope}`)\n\t\t\t\t}\n\t\t\t\tthis.log('Parsed HTML and found element')\n\n\t\t\t\t// Sanitize the HTML content\n\t\t\t\telement =\n\t\t\t\t\tincludeParent && sourceScope\n\t\t\t\t\t\t? DOMPurify.sanitize(element.outerHTML)\n\t\t\t\t\t\t: DOMPurify.sanitize(element.innerHTML)\n\t\t\t\treturn element\n\t\t\t})\n\t}\n\n\tfrom({ selector, url = window.location.href, includeParent = false, onStart, onEnd, onError }) {\n\t\tif (!selector) {\n\t\t\tconst error = new Error('Selector must be defined.')\n\t\t\tif (onError) {\n\t\t\t\tonError(error)\n\t\t\t} else {\n\t\t\t\tconsole.error(error)\n\t\t\t}\n\t\t\treturn Promise.reject(error)\n\t\t}\n\n\t\tif (onStart) onStart()\n\n\t\tconst cacheKey = `${url}-${selector}-${includeParent}`\n\t\tthis.log(`Cache key is: ${cacheKey}`)\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (this.cache.has(cacheKey)) {\n\t\t\t\tconst cachedData = this.cache.get(cacheKey)\n\t\t\t\tthis.log('Serving from cache')\n\t\t\t\tif (onEnd) onEnd(cachedData)\n\t\t\t\tresolve(cachedData)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tthis.log(`Fetching data from URL: ${url}`)\n\t\t\tif (url === window.location.href) {\n\t\t\t\tconst sourceElement = document.querySelector(selector)\n\t\t\t\tif (!sourceElement) {\n\t\t\t\t\tconst error = new Error(`Element not found for selector: ${selector}`)\n\t\t\t\t\tif (onError) {\n\t\t\t\t\t\tonError(error)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.error(error)\n\t\t\t\t\t}\n\t\t\t\t\treturn reject(error)\n\t\t\t\t}\n\t\t\t\tconst html = includeParent ? sourceElement.outerHTML : sourceElement.innerHTML\n\t\t\t\tconst sanitizedHtml = DOMPurify.sanitize(html)\n\t\t\t\tthis.cache.set(cacheKey, sanitizedHtml)\n\t\t\t\tif (onEnd) onEnd(sanitizedHtml)\n\t\t\t\tresolve(sanitizedHtml)\n\t\t\t} else {\n\t\t\t\tthis.fetchContent(url, selector, includeParent)\n\t\t\t\t\t.then((html) => {\n\t\t\t\t\t\tthis.cache.set(cacheKey, html)\n\t\t\t\t\t\tif (onEnd) onEnd(html)\n\t\t\t\t\t\tresolve(html)\n\t\t\t\t\t})\n\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\tif (onError) {\n\t\t\t\t\t\t\tonError(error)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconsole.error('Error fetching content:', error)\n\t\t\t\t\t\t}\n\t\t\t\t\t\treject(error)\n\t\t\t\t\t})\n\t\t\t}\n\t\t})\n\t}\n\n\tto({ destination, data, mode = 'replace', delay = 0, onStart, onEnd, onError }) {\n\t\tif (!destination || !data) {\n\t\t\tconst error = new Error('Destination and data must be defined.')\n\t\t\tif (onError) {\n\t\t\t\tonError(error)\n\t\t\t} else {\n\t\t\t\tconsole.error(error)\n\t\t\t}\n\t\t\treturn Promise.reject(error)\n\t\t}\n\n\t\tconst targetElement = typeof destination === 'string' ? document.querySelector(destination) : destination\n\t\tif (!targetElement) {\n\t\t\tconst error = new Error(`Target element not found for selector: ${destination}`)\n\t\t\tif (onError) {\n\t\t\t\tonError(error)\n\t\t\t} else {\n\t\t\t\tconsole.error(error)\n\t\t\t}\n\t\t\treturn Promise.reject(error)\n\t\t}\n\n\t\tif (onStart) onStart(targetElement)\n\n\t\t// Add loading class\n\t\ttargetElement.classList.add(this.options.loadingClass)\n\n\t\tconst insertContent = () => {\n\t\t\ttry {\n\t\t\t\tthis.log(`Inserting content via '${mode}' mode`)\n\t\t\t\tconst fragment = document.createDocumentFragment()\n\t\t\t\tconst tempDiv = document.createElement('div')\n\t\t\t\ttempDiv.innerHTML = data\n\n\t\t\t\tif (mode === 'prepend') {\n\t\t\t\t\tfor (const node of [...tempDiv.childNodes].reverse()) {\n\t\t\t\t\t\ttargetElement.insertBefore(node, targetElement.firstChild)\n\t\t\t\t\t}\n\t\t\t\t} else if (mode === 'append') {\n\t\t\t\t\ttargetElement.appendChild(tempDiv)\n\t\t\t\t} else {\n\t\t\t\t\ttargetElement.innerHTML = '' // Clear the existing content\n\t\t\t\t\ttargetElement.appendChild(tempDiv)\n\t\t\t\t}\n\n\t\t\t\t// Remove loading class and add loaded class\n\t\t\t\ttargetElement.classList.remove(this.options.loadingClass)\n\t\t\t\ttargetElement.classList.add(this.options.loadedClass)\n\n\t\t\t\tif (onEnd) onEnd(targetElement)\n\t\t\t\treturn Promise.resolve(targetElement)\n\t\t\t} catch (error) {\n\t\t\t\t// Remove loading class and add error class\n\t\t\t\ttargetElement.classList.remove(this.options.loadingClass)\n\t\t\t\ttargetElement.classList.add(this.options.errorClass)\n\n\t\t\t\tif (onError) {\n\t\t\t\t\tonError(error)\n\t\t\t\t} else {\n\t\t\t\t\tconsole.error('Error inserting content:', error)\n\t\t\t\t}\n\t\t\t\treturn Promise.reject(error)\n\t\t\t}\n\t\t}\n\n\t\tif (delay > 0) {\n\t\t\tthis.log(`Delaying insertion by ${delay} seconds`)\n\t\t\tsetTimeout(insertContent, delay * 1000)\n\t\t} else {\n\t\t\treturn insertContent()\n\t\t}\n\t}\n\n\tfromTo(fromParams, toParams) {\n\t\tthis.from(fromParams)\n\t\t\t.then((html) => {\n\t\t\t\treturn this.to({ ...toParams, data: html })\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\t// errors are handled in from() and to()\n\t\t\t})\n\t}\n\n\tabortFetch() {\n\t\tthis.controller.abort()\n\t\tthis.controller = new AbortController()\n\t\tthis.cache.clear()\n\t}\n}\n\nwindow.ContentFetch = ContentFetch"],"names":["ContentFetch","options","this","_extends","loadingClass","loadedClass","errorClass","debugMode","cache","Map","controller","AbortController","_proto","prototype","log","message","console","fetchContent","url","sourceScope","includeParent","_this","fetch","signal","then","response","ok","Error","text","data","doc","DOMParser","parseFromString","element","querySelector","body","DOMPurify","sanitize","outerHTML","innerHTML","from","_ref","_this2","selector","_ref$url","window","location","href","_ref$includeParent","onStart","onEnd","onError","error","Promise","reject","cacheKey","resolve","has","cachedData","get","sourceElement","document","sanitizedHtml","set","html","to","_ref2","_this3","destination","_ref2$mode","mode","_ref2$delay","delay","targetElement","classList","add","insertContent","createDocumentFragment","tempDiv","createElement","_iterator","_step","_createForOfIteratorHelperLoose","concat","childNodes","reverse","done","insertBefore","value","firstChild","appendChild","remove","setTimeout","fromTo","fromParams","toParams","_this4","abortFetch","abort","clear"],"mappings":"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"}